<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to British Hills Camp</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Google Font 'Inter' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 3. Configure Tailwind to use 'Inter' -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              inter: ['Inter', 'sans-serif'],
            },
          },
        },
      }
    </script>
    
    <!-- 4. Custom Styles for Form & Game -->
    <style>
      /* Ensure 'Inter' is the base font */
      body {
        font-family: 'Inter', sans-serif;
        scroll-behavior: smooth;
      }
      
      /* Style for the clickable interest tags */
      .interest-tag {
        transition: all 0.2s ease-in-out;
      }
      .interest-tag.selected {
        /* This class will be toggled by JS */
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      
      /* Styles for the matching game items */
      .game-item {
        transition: all 0.2s ease-in-out;
      }
      .game-item.selected {
        background-color: #dbeafe; /* blue-100 */
        border-color: #3b82f6; /* blue-600 */
        border-width: 2px;
        transform: scale(1.03);
      }
      .game-item.correct {
        background-color: #dcfce7; /* green-100 */
        border-color: #86efac; /* green-300 */
        color: #166534; /* green-800 */
        cursor: not-allowed;
        opacity: 0.8;
      }
      .game-item.incorrect {
        background-color: #fee2e2; /* red-100 */
        border-color: #fca5a5; /* red-400 */
        color: #991b1b; /* red-800 */
        animation: shake 0.5s ease-in-out;
      }
      
      /* Shake animation for incorrect pairs */
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
      }
    </style>
</head>
<body class="bg-sky-50 text-gray-800 antialiased"> <!-- Changed bg-gray-50 to bg-sky-50 -->

    <!-- Main Content Container -->
    <div class="container mx-auto max-w-4xl p-4 md:p-8 space-y-12">

        <!-- Section 1: Header -->
        <!-- Updated to be a gradient hero section -->
        <header class="text-center p-8 md:p-12 rounded-lg bg-gradient-to-br from-blue-600 to-teal-500 text-white shadow-lg">
            <h1 class="text-4xl md:text-5xl font-bold">Welcome to the Camp!</h1>
            <p class="mt-2 text-lg text-blue-100">We're excited to have you at British Hills.</p>
        </header>

        <!-- Section 2: Welcome Note (RESTORED) -->
        <section class="bg-white p-6 md:p-8 rounded-lg shadow-md">
            <div class="flex items-center gap-3 mb-4">
                <!-- Sparkles Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                </svg>
                <h2 class="text-2xl font-semibold text-blue-600">A Quick Welcome</h2>
            </div>
            <div class="space-y-4 text-gray-700">
                <p>
                    Hello and welcome! We've put together this little page for you to share a bit about yourself with our camp leaders.
                </p>
                <p>
                    The profile form and the game below are <strong>completely optional</strong>, so feel free to fill out as much or as little as you like. It's just a fun way for us to get to know you before you arrive.
                </p>
                <p>
                    We're looking forward to a fantastic time together!
                </p>
            </div>
        </section>

        <!-- Section 3: Profile Form (RESTORED) -->
        <form id="profile-form" class="bg-white p-6 md:p-8 rounded-lg shadow-md space-y-6">
            <div class="flex items-center gap-3 border-b border-gray-200 pb-3">
                <!-- User Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <h2 class="text-2xl font-semibold text-blue-600">My Camp Profile (Optional)</h2>
            </div>
            
            <!-- Full Name (Required) -->
            <div>
                <label for="full-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input type="text" id="full-name" name="full-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            
            <!-- Nickname -->
            <div>
                <label for="nickname" class="block text-sm font-medium text-gray-700 mb-1">What would you like to be called? (Nickname)</label>
                <input type="text" id="nickname" name="nickname" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Interests (Tags) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">What are your interests?</label>
                <div id="interest-tags" class="flex flex-wrap gap-3">
                    <!-- JS will look for .interest-tag and data-interest -->
                    <!-- Updated tag styling to be blue-based -->
                    <button type="button" class="interest-tag px-4 py-2 rounded-full font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 hover:shadow-sm" data-interest="sports">Sports</button>
                    <button type="button" class="interest-tag px-4 py-2 rounded-full font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 hover:shadow-sm" data-interest="music">Music</button>
                    <button type="button" class="interest-tag px-4 py-2 rounded-full font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 hover:shadow-sm" data-interest="video-games">Video Games</button>
                    <button type="button" class="interest-tag px-4 py-2 rounded-full font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 hover:shadow-sm" data-interest="reading">Reading</button>
                    <button type="button" class="interest-tag px-4 py-2 rounded-full font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 hover:shadow-sm" data-interest="art">Art</button>
                    <button type="button" class="interest-tag px-4 py-2 rounded-full font-medium bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200 hover:shadow-sm" data-interest="other">Other</button>
                </div>
            </div>
            
            <!-- Conditional Interest Inputs -->
            <div id="interest-inputs" class="space-y-4 pt-2">
                <input type="text" id="sports-input" name="sports-detail" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="What sports do you like?">
                <input type="text" id="music-input" name="music-detail" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="What music do you like?">
                <input type="text" id="video-games-input" name="video-games-detail" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="What video games do you like?">
                <input type="text" id="reading-input" name="reading-detail" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="What kind of books do you like?">
                <input type="text" id="art-input" name="art-detail" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="What kind of art do you like?">
                <input type="text" id="other-input" name="other-detail" class="hidden w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Please specify...">
            </div>
            
            <!-- Camp Goal -->
            <div>
                <label for="goal" class="block text-sm font-medium text-gray-700 mb-1">My Goal at British Hills</label>
                <textarea id="goal" name="goal" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="One thing I want to improve is..."></textarea>
            </div>
            
            <!-- Superpower -->
            <div>
                <label for="superpower" class="block text-sm font-medium text-gray-700 mb-1">Icebreaker: If you could have one superpower, what would it be and why?</label>
                <textarea id="superpower" name="superpower" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="If I could have one superpower, it would be..."></textarea>
            </div>

            <!-- Submit Button -->
            <div class="text-right">
                <button type="submit" id="submit-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors disabled:bg-gray-400">
                    Submit Profile
                </button>
            </div>
        </form>

        <!-- Section 4: Game -->
        <!-- Updated shadow and added an icon -->
        <section class="bg-white p-6 md:p-8 rounded-lg shadow-md">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center border-b border-gray-200 pb-3 mb-6 gap-4">
                <div class="flex items-center gap-3">
                    <!-- Puzzle Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 011-1h1a2 2 0 100-4H7a1 1 0 01-1-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                    </svg>
                    <!-- Title updated as requested -->
                    <h2 class="text-2xl font-semibold text-blue-600">Test Yourself: British English vs. American English</h2>
                </div>
                <!-- Updated button styling -->
                <button id="reset-game-btn" class="px-4 py-2 bg-blue-50 text-blue-700 font-medium rounded-md shadow-sm hover:bg-blue-100 border border-blue-200 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Reset Game
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 md:gap-8">
                <!-- Column 1: British English -->
                <div>
                    <h3 class="text-lg font-semibold text-center mb-4">British</h3>
                    <div id="british-col" class="space-y-3">
                        <!-- Items will be populated by JS -->
                    </div>
                </div>
                <!-- Column 2: American English -->
                <div>
                    <h3 class="text-lg font-semibold text-center mb-4">American</h3>
                    <div id="american-col" class="space-y-3">
                        <!-- Items will be populated by JS -->
                    </div>
                </div>
            </div>
        </section>

    </div> <!-- End Main Container -->
    
    <!-- Success/Error Modal -->
    <!-- Updated modal styling for a softer look -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div id="modal-content" class="bg-white rounded-xl shadow-xl p-8 w-full max-w-md text-center transform transition-all scale-95 opacity-0">
            <h3 id="modal-title" class="text-2xl font-semibold text-gray-900"></h3>
            <p id="modal-message" class="mt-2 text-gray-600"></p>
            <button id="close-modal-btn" class="mt-6 px-5 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Got it!
            </button>
        </div>
    </div>


    <!-- 5. Firebase SDKs -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCXr9MHZ6vRJ6_u5zWL7x-OatnxEGj2VYU",
          authDomain: "long-english-camp.firebaseapp.com",
          projectId: "long-english-camp",
          storageBucket: "long-english-camp.firebasestorage.app",
          messagingSenderId: "881175905434",
          appId: "1:881175905434:web:ac95bb0b19274f8c820b23"
        };

        // --- Initialize Firebase (Synchronous Part) ---
        let app, auth, db, user;
        try {
            // This part is synchronous and will not block
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            // 'app' will be null, which we check for in DOMContentLoaded
        }

        // --- DOM Elements ---
        let profileForm, submitBtn, interestTagsContainer, interestInputsContainer;
        let modal, modalContent, modalTitle, modalMessage, closeModalBtn;
        let britishCol, americanCol, resetGameBtn;

        // --- Modal Logic (defined early so it can be used by init error) ---
        
        function showModal(title, message, isError = false) {
            // Ensure modal elements are found *before* using them
            if (!modal) {
                modal = document.getElementById('modal');
                modalContent = document.getElementById('modal-content');
                modalTitle = document.getElementById('modal-title');
                modalMessage = document.getElementById('modal-message');
                closeModalBtn = document.getElementById('close-modal-btn');

                // Add listeners only once
                closeModalBtn.addEventListener('click', hideModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideModal();
                    }
                });
            }

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Clear any error styling
            modalTitle.classList.remove('text-red-600');
            closeModalBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
            
            // Add error styling if needed
            if (isError) {
                modalTitle.classList.add('text-red-600');
                closeModalBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
            } else {
                closeModalBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
            }
            
            modal.classList.remove('hidden');
            // Trigger transition
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        
        function hideModal() {
            if (!modalContent) return; // Not initialized
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                if (modal) modal.classList.add('hidden');
            }, 200); // Match transition duration
        }
        
        // REMOVED: Check for init error (moved inside DOMContentLoaded)
        /*
        if (!app) {
             showModal("Initialization Failed", "Could not connect to the server. Please refresh the page.", true);
        }
        */


        // --- 1. Form Logic ---
        
        function initFormLogic() {
            profileForm = document.getElementById('profile-form');
            submitBtn = document.getElementById('submit-btn');
            interestTagsContainer = document.getElementById('interest-tags');
            interestInputsContainer = document.getElementById('interest-inputs');

            // The error was here: these elements might be null if script runs too early
            // OR if the elements are missing. We fixed the missing elements.
            if (interestTagsContainer) {
                interestTagsContainer.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('interest-tag')) return;
                    
                    const btn = e.target;
                    const interest = btn.dataset.interest;
                    const inputField = document.getElementById(`${interest}-input`);
                    
                    // Toggle tag visual state
                    btn.classList.toggle('selected');
                    btn.classList.toggle('bg-blue-50');
                    btn.classList.toggle('text-blue-700');
                    btn.classList.toggle('border-blue-200');
                    btn.classList.toggle('bg-blue-600');
                    btn.classList.toggle('text-white');
                    btn.classList.toggle('border-blue-600'); // Add/remove selected border
                    
                    // Toggle corresponding input field
                    if (inputField) {
                        inputField.classList.toggle('hidden');
                    }
                });
            } else {
                console.error("Could not find 'interest-tags' container.");
            }

            if(profileForm) {
                profileForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!user) {
                        showModal("Authentication Error", "Not connected. Please refresh the page and try again.", true);
                        return;
                    }
                    
                    // Show submitting state
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    const formData = new FormData(profileForm);
                    const interests = {};
                    
                    // Collect selected interests and their details
                    document.querySelectorAll('.interest-tag.selected').forEach(tag => {
                        const interest = tag.dataset.interest;
                        const detail = formData.get(`${interest}-detail`) || "";
                        interests[interest] = detail;
                    });

                    // Prepare data for Firestore
                    const profileData = {
                        userId: user.uid, // Store the anonymous user ID
                        fullName: formData.get('full-name'),
                        nickname: formData.get('nickname'),
                        goal: formData.get('goal'),
                        superpower: formData.get('superpower'),
                        interests: interests,
                        createdAt: serverTimestamp() // Use server-side timestamp
                    };
                    
                    try {
                        // Save to Firestore
                        const docRef = await addDoc(collection(db, "studentProfiles"), profileData);
                        console.log("Document written with ID: ", docRef.id);
                        
                        // Show success modal
                        showModal("Thank You!", "Your profile has been submitted successfully.");
                        
                        // Reset form
                        profileForm.reset();
                        document.querySelectorAll('.interest-tag.selected').forEach(tag => {
                            tag.classList.remove('selected', 'bg-blue-600', 'text-white', 'border-blue-600');
                            tag.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-200');
                        });
                        document.querySelectorAll('#interest-inputs input').forEach(input => {
                            input.classList.add('hidden');
                        });
                        
                    } catch (error) {
                        console.error("Error adding document: ", error);
                        // Show error modal
                        showModal("Submission Failed", "There was an error submitting your profile. Please try again.", true);
                    } finally {
                        // Reset button state
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Profile';
                    }
                });
            } else {
                console.error("Could not find 'profile-form'.");
            }
        }

        // --- 2. Game Logic ---
        
        const wordPairs = {
            'Trousers': 'Pants',
            'Lift': 'Elevator',
            'Biscuit': 'Cookie',
            'Flat': 'Apartment',
            'Queue': 'Line',
            'Rubbish': 'Garbage / Trash',
            'Chips': 'French Fries',
            'Post': 'Mail'
        };

        let selectedBritish = null;
        let selectedAmerican = null;
        let correctMatches = 0;
        
        // Utility to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        // Function to create a game item element
        function createGameItem(text) {
            const item = document.createElement('div');
            // Updated item styling
            item.className = 'game-item p-3 rounded-lg border border-gray-200 bg-white shadow-sm cursor-pointer hover:bg-gray-50 hover:border-blue-300 text-center font-medium';
            item.textContent = text;
            return item;
        }
        
        // Initialize the game board
        function initGame() {
            // Find elements here
            britishCol = document.getElementById('british-col');
            americanCol = document.getElementById('american-col');
            resetGameBtn = document.getElementById('reset-game-btn');

            if (!britishCol || !americanCol || !resetGameBtn) {
                console.error("Game elements not found.");
                return;
            }

            britishCol.innerHTML = '';
            americanCol.innerHTML = '';
            selectedBritish = null;
            selectedAmerican = null;
            correctMatches = 0;
            
            const britishWords = Object.keys(wordPairs);
            const americanWords = shuffleArray(Object.values(wordPairs));
            
            britishWords.forEach(word => {
                britishCol.appendChild(createGameItem(word));
            });
            
            americanWords.forEach(word => {
                americanCol.appendChild(createGameItem(word));
            });

            // Add listeners
            britishCol.addEventListener('click', (e) => {
                const item = e.target;
                if (!item.classList.contains('game-item') || item.classList.contains('correct')) return;
                
                if (selectedBritish) {
                    selectedBritish.classList.remove('selected');
                }
                selectedBritish = item;
                selectedBritish.classList.add('selected');
                
                checkMatch();
            });
            
            americanCol.addEventListener('click', (e) => {
                const item = e.target;
                if (!item.classList.contains('game-item') || item.classList.contains('correct')) return;
                
                if (selectedAmerican) {
                    selectedAmerican.classList.remove('selected');
                }
                selectedAmerican = item;
                selectedAmerican.classList.add('selected');
                
                checkMatch();
            });
            
            resetGameBtn.addEventListener('click', initGame);
        }
        
        // Check if the selected pair is a match
        function checkMatch() {
            if (!selectedBritish || !selectedAmerican) return;
            
            const britishWord = selectedBritish.textContent;
            const americanWord = selectedAmerican.textContent;
            
            if (wordPairs[britishWord] === americanWord) {
                // Correct match
                selectedBritish.classList.add('correct');
                selectedAmerican.classList.add('correct');
                selectedBritish.classList.remove('selected');
                selectedAmerican.classList.remove('selected');
                
                selectedBritish = null;
                selectedAmerican = null;
                correctMatches++;
                
                if (correctMatches === Object.keys(wordPairs).length) {
                    showModal("Well Done!", "You found all the matches!");
                }
                
            } else {
                // Incorrect match
                selectedBritish.classList.add('incorrect');
                selectedAmerican.classList.add('incorrect');
                
                // Remove visual feedback after a delay
                setTimeout(() => {
                    if (selectedBritish) selectedBritish.classList.remove('incorrect', 'selected');
                    if (selectedAmerican) selectedAmerican.classList.remove('incorrect', 'selected');
                    selectedBritish = null;
                    selectedAmerican = null;
                }, 800);
            }
        }

        // --- Initial Page Load ---
        // Wait for the DOM to be fully loaded before trying to find elements
        document.addEventListener("DOMContentLoaded", () => {
            
            // 1. Always set up the modal first, so we can show errors
            if (!modal) {
                modal = document.getElementById('modal');
                modalContent = document.getElementById('modal-content');
                modalTitle = document.getElementById('modal-title');
                modalMessage = document.getElementById('modal-message');
                closeModalBtn = document.getElementById('close-modal-btn');

                // Add listeners only once, with null checks
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', hideModal);
                }
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            hideModal();
                        }
                    });
                }
            }
            
            // 2. Always initialize the game. It has no dependencies.
            // This will run immediately.
            initGame();

            // 3. Initialize the form logic. 
            // The submit handler inside this function will check for a valid 'user' object.
            initFormLogic();
            
            // 4. Check for Firebase *Initialization* error
            if (!app) {
                 // We can safely call showModal now
                 showModal("Form Disabled", "Could not connect to the server. The game is playable, but the profile form is disabled.", true);
                 
                 // Also, find the submit button and disable it
                 const formSubmitBtn = document.getElementById('submit-btn');
                 if(formSubmitBtn) {
                    formSubmitBtn.disabled = true;
                    formSubmitBtn.textContent = 'Form Disabled';
                 }
            } else {
                // 5. If init was OK, *now* try to sign in asynchronously
                (async () => {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        user = userCredential.user;
                        console.log('Firebase Anonymous Sign-In successful. User ID:', user.uid);
                    } catch (error) {
                        console.error("Firebase Sign-In Error:", error);
                        showModal("Form Disabled", "Could not authenticate with the server. The game is playable, but the profile form is disabled.", true);
                        const formSubmitBtn = document.getElementById('submit-btn');
                        if (formSubmitBtn) {
                            formSubmitBtn.disabled = true;
                            formSubmitBtn.textContent = 'Form Disabled';
                        }
                    }
                })();
            }

        });

    </script>
</body>
</html>

